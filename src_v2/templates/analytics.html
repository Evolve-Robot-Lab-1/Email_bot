{% extends "layout.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-gray-900">Analytics Dashboard</h2>
            <p class="text-gray-600 mt-1">Track your campaign performance</p>
        </div>
        <button id="export-btn" class="btn btn-secondary">
            <i class="fas fa-download mr-2"></i>Export Data
        </button>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="stat-card gradient-blue text-white">
            <div class="stat-value">{{ total_sent }}</div>
            <div class="stat-label text-blue-100">Total Emails Sent</div>
        </div>
        <div class="stat-card gradient-green text-white">
            <div class="stat-value">{{ campaign_history|length }}</div>
            <div class="stat-label text-green-100">Total Campaigns</div>
        </div>
        <div class="stat-card bg-gradient-to-br from-yellow-400 to-orange-500 text-white">
            <div class="stat-value" id="success-rate">--</div>
            <div class="stat-label text-yellow-100">Success Rate</div>
        </div>
        <div class="stat-card bg-gradient-to-br from-purple-400 to-pink-500 text-white">
            <div class="stat-value" id="avg-per-campaign">--</div>
            <div class="stat-label text-purple-100">Avg per Campaign</div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Success/Failure Chart -->
        <div class="card">
            <div class="card-header">
                <span><i class="fas fa-chart-pie mr-2 text-blue-600"></i>Email Status Distribution</span>
            </div>
            <canvas id="statusChart" height="200"></canvas>
        </div>

        <!-- Campaigns Over Time -->
        <div class="card">
            <div class="card-header">
                <span><i class="fas fa-chart-line mr-2 text-blue-600"></i>Emails Sent Over Time</span>
            </div>
            <canvas id="timelineChart" height="200"></canvas>
        </div>
    </div>

    <!-- Campaign History Table -->
    <div class="card">
        <div class="card-header">
            <span><i class="fas fa-history mr-2 text-blue-600"></i>Campaign History</span>
            <div class="flex items-center space-x-2">
                <input type="text" id="search-campaigns" class="form-input" style="width: 300px;" placeholder="Search campaigns...">
            </div>
        </div>

        {% if campaign_history %}
        <div class="overflow-x-auto">
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Total</th>
                        <th>Sent</th>
                        <th>Failed</th>
                        <th>Success Rate</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="campaigns-tbody">
                    {% for campaign in campaign_history %}
                    <tr>
                        <td class="font-medium text-gray-900">
                            {{ campaign.date[:10] if campaign.date else 'Unknown' }}
                        </td>
                        <td>{{ campaign.total }}</td>
                        <td class="text-green-600 font-medium">{{ campaign.sent }}</td>
                        <td class="text-red-600 font-medium">{{ campaign.failed }}</td>
                        <td>
                            {% set success_rate = (campaign.sent / campaign.total * 100) if campaign.total > 0 else 0 %}
                            <span class="badge {% if success_rate >= 90 %}badge-success{% elif success_rate >= 70 %}badge-warning{% else %}badge-danger{% endif %}">
                                {{ "%.1f"|format(success_rate) }}%
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-secondary btn-sm view-details-btn" data-index="{{ loop.index0 }}">
                                <i class="fas fa-eye mr-1"></i>Details
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-chart-bar text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">No campaign data yet</p>
            <p class="text-sm text-gray-400 mt-2">Launch your first campaign to see analytics</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Campaign Details Modal -->
<div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 flex justify-between items-center">
            <h3 class="text-2xl font-bold">Campaign Details</h3>
            <button id="close-details-modal" class="hover:bg-white/20 rounded-full p-2">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
            <!-- Campaign summary -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="stat-card bg-blue-50">
                    <div class="stat-value text-blue-600" id="detail-total">0</div>
                    <div class="stat-label">Total Emails</div>
                </div>
                <div class="stat-card bg-green-50">
                    <div class="stat-value text-green-600" id="detail-sent">0</div>
                    <div class="stat-label">Successfully Sent</div>
                </div>
                <div class="stat-card bg-red-50">
                    <div class="stat-value text-red-600" id="detail-failed">0</div>
                    <div class="stat-label">Failed</div>
                </div>
            </div>

            <!-- Detailed progress -->
            <h4 class="font-semibold text-gray-900 mb-3">Email-by-Email Breakdown</h4>
            <div id="detail-progress" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- Progress items will be added here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const campaignHistory = {{ campaign_history|tojson|safe }};

// Calculate stats
function calculateStats() {
    if (campaignHistory.length === 0) return;

    let totalSent = 0;
    let totalFailed = 0;
    let totalEmails = 0;

    campaignHistory.forEach(campaign => {
        totalSent += campaign.sent || 0;
        totalFailed += campaign.failed || 0;
        totalEmails += campaign.total || 0;
    });

    const successRate = totalEmails > 0 ? (totalSent / totalEmails * 100).toFixed(1) : 0;
    const avgPerCampaign = campaignHistory.length > 0 ? (totalSent / campaignHistory.length).toFixed(0) : 0;

    document.getElementById('success-rate').textContent = successRate + '%';
    document.getElementById('avg-per-campaign').textContent = avgPerCampaign;
}

// Initialize charts
function initCharts() {
    if (campaignHistory.length === 0) return;

    // Status distribution chart
    let totalSent = 0;
    let totalFailed = 0;

    campaignHistory.forEach(campaign => {
        totalSent += campaign.sent || 0;
        totalFailed += campaign.failed || 0;
    });

    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Successful', 'Failed'],
            datasets: [{
                data: [totalSent, totalFailed],
                backgroundColor: ['#10b981', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Timeline chart
    const dates = campaignHistory.map(c => c.date ? c.date.substring(0, 10) : 'Unknown');
    const sentData = campaignHistory.map(c => c.sent || 0);
    const failedData = campaignHistory.map(c => c.failed || 0);

    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    new Chart(timelineCtx, {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'Sent',
                    data: sentData,
                    backgroundColor: '#10b981',
                    borderRadius: 6
                },
                {
                    label: 'Failed',
                    data: failedData,
                    backgroundColor: '#ef4444',
                    borderRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                x: { stacked: true },
                y: {
                    stacked: true,
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// View campaign details
document.querySelectorAll('.view-details-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const index = parseInt(btn.dataset.index);
        showCampaignDetails(campaignHistory[index]);
    });
});

function showCampaignDetails(campaign) {
    document.getElementById('detail-total').textContent = campaign.total || 0;
    document.getElementById('detail-sent').textContent = campaign.sent || 0;
    document.getElementById('detail-failed').textContent = campaign.failed || 0;

    const progressDiv = document.getElementById('detail-progress');
    progressDiv.innerHTML = '';

    if (campaign.progress && campaign.progress.length > 0) {
        campaign.progress.forEach(item => {
            const div = document.createElement('div');
            div.className = `flex justify-between items-center p-3 rounded-lg ${
                item.status === 'sent' ? 'bg-green-50' : 'bg-red-50'
            }`;
            div.innerHTML = `
                <div>
                    <p class="font-medium text-gray-900">${item.company || 'Unknown'}</p>
                    <p class="text-sm text-gray-600">${item.email}</p>
                    ${item.error ? `<p class="text-xs text-red-600 mt-1">${item.error}</p>` : ''}
                </div>
                <span class="badge badge-${item.status === 'sent' ? 'success' : 'danger'}">
                    ${item.status}
                </span>
            `;
            progressDiv.appendChild(div);
        });
    } else {
        progressDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No detailed progress data available</p>';
    }

    document.getElementById('details-modal').classList.remove('hidden');
    document.getElementById('details-modal').classList.add('flex');
}

document.getElementById('close-details-modal').addEventListener('click', () => {
    document.getElementById('details-modal').classList.add('hidden');
    document.getElementById('details-modal').classList.remove('flex');
});

// Search campaigns
document.getElementById('search-campaigns')?.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#campaigns-tbody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });
});

// Export data
document.getElementById('export-btn').addEventListener('click', () => {
    if (campaignHistory.length === 0) {
        showToast('No data to export', 'warning');
        return;
    }

    // Create CSV
    let csv = 'Date,Total,Sent,Failed,Success Rate\n';

    campaignHistory.forEach(campaign => {
        const successRate = campaign.total > 0 ?
            (campaign.sent / campaign.total * 100).toFixed(1) : 0;
        csv += `${campaign.date || 'Unknown'},${campaign.total},${campaign.sent},${campaign.failed},${successRate}%\n`;
    });

    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `campaign-analytics-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();

    showToast('Data exported successfully', 'success');
});

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    calculateStats();
    initCharts();
});
</script>
{% endblock %}
