{% extends "layout.html" %}

{% block title %}Campaign Builder{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-gray-900">Campaign Builder <span class="text-xs text-green-600 ml-2">v2.1 Fixed</span></h2>
            <p class="text-gray-600 mt-1">Upload recipients, customize emails, and launch your campaign</p>
        </div>
        <div class="flex space-x-3">
            <button id="bulk-edit-btn" class="btn btn-secondary hidden">
                <i class="fas fa-edit mr-2"></i>Bulk Edit
            </button>
            <button id="ai-generate-all-btn" class="btn btn-primary hidden">
                <i class="fas fa-magic mr-2"></i>AI Generate All
            </button>
        </div>
    </div>

    <!-- Step 1: Setup Campaign -->
    <div class="card">
        <div class="card-header">
            <span><i class="fas fa-cog mr-2 text-blue-600"></i>Step 1: Setup Campaign</span>
            <span class="text-sm font-normal text-gray-500">Configure recipients and email template</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Left Column: Recipients & Settings (50%) -->
            <div class="space-y-4 h-fit">
                <!-- CSV Upload -->
                <div>
                    <label class="form-label">
                        <i class="fas fa-cloud-upload-alt mr-2"></i>Upload Recipients (CSV/Excel)
                    </label>
                    <input type="file" id="file-input" accept=".csv,.xlsx,.xls" class="hidden">
                    <div id="upload-area" class="upload-area">
                        <i class="fas fa-file-upload text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-700 font-medium">Drag & drop your file here</p>
                        <p class="text-sm text-gray-500 mt-2">or click to browse</p>
                        <p class="text-xs text-gray-400 mt-3">Supports CSV, Excel (max 5MB)</p>
                    </div>
                </div>

                <!-- Upload Summary Stats -->
                <div id="upload-stats" class="hidden">
                    <div class="grid grid-cols-3 gap-2">
                        <div class="p-3 bg-blue-50 rounded-lg text-center">
                            <div id="total-count" class="text-2xl font-bold text-blue-600">0</div>
                            <div class="text-xs text-gray-600">Recipients</div>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg text-center">
                            <div id="valid-count" class="text-2xl font-bold text-green-600">0</div>
                            <div class="text-xs text-gray-600">Valid</div>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg text-center">
                            <div id="time-estimate" class="text-2xl font-bold text-purple-600">--</div>
                            <div class="text-xs text-gray-600">Est. Time</div>
                        </div>
                    </div>
                </div>

                <!-- Subject Line -->
                <div>
                    <label class="form-label">
                        <i class="fas fa-heading mr-2"></i>Subject Line
                    </label>
                    <input type="text" id="subject-template" class="form-input"
                           placeholder="Use {{company}} for personalization..."
                           value="Legal AI - India opportunity">
                    <p class="text-xs text-gray-500 mt-1">
                        Use <strong>{{company}}</strong> for company name
                    </p>
                </div>

                <!-- Product Description -->
                <div>
                    <label class="form-label">
                        <i class="fas fa-box mr-2"></i>Product Description
                    </label>
                    <textarea id="product-info" rows="3" class="form-input"
                              placeholder="What your product does, key benefits, traction...">AI-powered legal document automation. Lawyers review AI drafts instead of writing from scratch. 50+ active lawyers, 3 enterprise pilots, $15K MRR growing 40% MoM.</textarea>
                </div>

                <!-- Campaign Settings -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="form-label">
                            <i class="fas fa-users mr-2"></i>Audience
                        </label>
                        <select id="audience-select" class="form-input">
                            <option value="VCs">VCs</option>
                            <option value="Clients">Clients</option>
                            <option value="Partners">Partners</option>
                            <option value="Investors">Investors</option>
                            <option value="Prospects">Prospects</option>
                            <option value="Media">Media</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">
                            <i class="fas fa-pen-fancy mr-2"></i>Style
                        </label>
                        <select id="email-style-select" class="form-input">
                            <option value="custom">Custom Template</option>
                            <option value="concise">Concise VC</option>
                            <option value="standard">Standard</option>
                        </select>
                    </div>
                </div>
                <p class="text-xs text-gray-500 -mt-2">
                    <span id="style-description">Custom: You write email, AI adds WHY section</span>
                </p>

                <!-- Advanced Settings (Collapsible) -->
                <details class="border border-gray-200 rounded-lg">
                    <summary class="cursor-pointer font-semibold text-gray-700 p-3 hover:bg-gray-50 rounded-lg">
                        <i class="fas fa-cog mr-2"></i>Advanced Settings
                    </summary>
                    <div class="p-4 space-y-4 border-t border-gray-200">
                        <!-- Company Details -->
                        <div>
                            <label class="form-label">
                                <i class="fas fa-building mr-2"></i>Your Company Details
                            </label>
                            <textarea id="company-info" rows="2" class="form-input"
                                      placeholder="Company name, founder background, team size...">Durga AI - Founded by ex-Google AI lead. 6 months in market. Team of 8. Backed by angel investors.</textarea>
                            <p class="text-xs text-gray-500 mt-1">Helps AI personalize emails better</p>
                        </div>

                        <!-- Sending Interval -->
                        <div>
                            <label class="form-label">
                                <i class="fas fa-clock mr-2"></i>Sending Interval
                            </label>
                            <select id="interval-select" class="form-input">
                                <option value="60">1 minute</option>
                                <option value="120" selected>2 minutes</option>
                                <option value="300">5 minutes</option>
                                <option value="600">10 minutes</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Time between each email</p>
                        </div>

                        <!-- Additional Materials Upload -->
                        <div>
                            <label class="form-label">
                                <i class="fas fa-paperclip mr-2"></i>Attachments (Pitch Deck, etc.)
                            </label>
                            <input type="file" id="materials-input" multiple accept=".pdf,.docx,.doc,.jpg,.jpeg,.png,.gif,.mp4,.avi,.mov" class="hidden">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-blue-500 transition cursor-pointer" id="materials-upload-area">
                                <div class="text-center">
                                    <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-1"></i>
                                    <p class="text-sm text-gray-700">Upload materials</p>
                                    <p class="text-xs text-gray-500">PDF, DOCX, Images, Videos</p>
                                </div>
                            </div>
                            <div id="materials-list" class="mt-2 space-y-1 hidden">
                                <!-- Uploaded files will appear here -->
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Generate Button -->
                <button id="generate-emails-btn" class="btn btn-primary w-full hidden">
                    <i class="fas fa-magic mr-2"></i>Generate AI Emails
                </button>
            </div>

            <!-- Right Column: Email Template (50%) -->
            <div class="h-fit md:sticky md:top-6">
                <label class="form-label">
                    <i class="fas fa-file-alt mr-2"></i>Your Email Message
                    <span class="text-red-500" id="template-required">*</span>
                </label>
                <textarea id="message-template" rows="22" class="form-input"
                          placeholder="Paste your email here. Add {{why}} where AI should insert 2-3 lines explaining why THIS company needs your product...">Dear {{company}},

Legal marketplaces failed because lawyers made less money through platforms than working direct.

AI changed this. Now lawyers review AI drafts instead of writing from scratch. They earn more per hour. Customers pay less. Platform wins. First time the economics work.

{{why}}

We're live. Lawyers joining unprompted. Enterprise pilots starting. Early revenue flowing.

Crosby proved this in the US. India's 10x bigger. Nobody's figured it out here yet.

6 month window before competitors catch up.

Building India's legal infrastructure, starting with documents, expanding to everything.

Worth a call?

Praveen
Founder, Durga AI</textarea>
                <p class="text-xs text-gray-500 mt-1">
                    Add <strong>{{why}}</strong> where you want AI to insert 2-3 personalized lines. Use <strong>{{company}}</strong> for company name.
                </p>
            </div>
        </div>

        <!-- Validation Errors (Initially Hidden) -->
        <div id="validation-errors" class="hidden mt-4 bg-red-50 border-l-4 border-red-500 p-4 rounded">
            <div class="flex">
                <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-2"></i>
                <div>
                    <h4 class="font-semibold text-red-800 mb-2">Please fix the following:</h4>
                    <ul id="error-list" class="list-disc ml-4 text-sm text-red-700 space-y-1">
                        <!-- Errors will be populated here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Preview & Edit Emails -->
    <div id="email-preview-section" class="card hidden">
        <div class="card-header">
            <span><i class="fas fa-envelope-open-text mr-2 text-blue-600"></i>Step 2: Review & Edit Emails</span>
            <span class="text-sm font-normal text-gray-500">
                <span id="emails-count">0</span> emails ready
            </span>
        </div>

        <!-- Email list -->
        <div id="email-list" class="space-y-4 max-h-96 overflow-y-auto">
            <!-- Emails will be populated here -->
        </div>

        <!-- Actions -->
        <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-clock mr-2"></i>
                    Sending interval: <span class="font-bold" id="interval-display">2 minutes</span> between emails
                </div>
                <div class="flex space-x-3">
                    <button id="test-email-btn" class="btn btn-secondary">
                        <i class="fas fa-flask mr-2"></i>Send Test Email
                    </button>
                    <button id="start-campaign-btn" class="btn btn-success btn-lg">
                        <i class="fas fa-rocket mr-2"></i>Launch Campaign
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: Campaign Progress -->
    <div id="campaign-progress-section" class="card hidden">
        <div class="card-header">
            <span><i class="fas fa-paper-plane mr-2 text-blue-600"></i>Campaign in Progress</span>
            <div class="flex space-x-2">
                <button id="pause-btn" class="btn btn-warning btn-sm">
                    <i class="fas fa-pause mr-2"></i>Pause
                </button>
                <button id="resume-btn" class="btn btn-success btn-sm hidden">
                    <i class="fas fa-play mr-2"></i>Resume
                </button>
                <button id="cancel-btn" class="btn btn-danger btn-sm">
                    <i class="fas fa-stop mr-2"></i>Cancel
                </button>
            </div>
        </div>

        <!-- Progress bar -->
        <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span>Progress: <span id="progress-text">0 / 0</span></span>
                <span><span id="progress-percent">0</span>%</span>
            </div>
            <div class="progress">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="stat-card bg-green-50">
                <div class="stat-value text-green-600" id="sent-count">0</div>
                <div class="stat-label">Sent</div>
            </div>
            <div class="stat-card bg-red-50">
                <div class="stat-value text-red-600" id="failed-count">0</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card bg-blue-50">
                <div class="stat-value text-blue-600" id="pending-count">0</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>

        <!-- Detailed progress -->
        <div>
            <h4 class="font-semibold text-gray-700 mb-3">Detailed Progress</h4>
            <div id="progress-details" class="max-h-64 overflow-y-auto space-y-2">
                <!-- Progress items will be added here -->
            </div>
        </div>
    </div>
</div>

<!-- Email Edit Modal -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 flex justify-between items-center">
            <h3 class="text-2xl font-bold">Edit Email</h3>
            <button id="close-modal" class="hover:bg-white/20 rounded-full p-2">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
            <!-- Company info -->
            <div class="bg-gray-50 rounded-lg p-4 mb-4" id="modal-company-info">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-bold text-gray-900" id="modal-company-name" data-company-name="">Company Name</h4>
                        <p class="text-sm text-gray-600" id="modal-company-email" data-company-email="">email@example.com</p>
                    </div>
                    <button id="ai-enhance-btn" class="btn btn-primary btn-sm">
                        <i class="fas fa-magic mr-2"></i>AI Enhance
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 hidden" id="modal-company-details" data-company-details="">Details...</p>
            </div>

            <!-- Subject -->
            <div class="mb-4">
                <label class="form-label">Subject Line</label>
                <input type="text" id="modal-subject" class="form-input" placeholder="Email subject...">
                <div class="text-xs text-gray-500 mt-1">
                    <span id="subject-length">0</span> characters
                </div>
            </div>

            <!-- Body -->
            <div class="mb-4">
                <label class="form-label">Email Body</label>
                <textarea id="modal-body" rows="12" class="form-input" data-email-body
                          placeholder="Email content..."></textarea>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span><span id="body-words">0</span> words | <span id="body-chars">0</span> characters</span>
                    <span id="word-target" class="text-green-600">Target: 100-150 words</span>
                </div>
            </div>

            <!-- AI suggestions -->
            <div id="ai-suggestions" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h5 class="font-semibold text-blue-900 mb-2">
                    <i class="fas fa-lightbulb mr-2"></i>AI Suggestions
                </h5>
                <ul id="suggestions-list" class="list-disc list-inside text-sm text-blue-800 space-y-1">
                    <!-- Suggestions will be added here -->
                </ul>
            </div>
        </div>

        <div class="border-t border-gray-200 p-6 flex justify-between">
            <button id="get-suggestions-btn" class="btn btn-secondary">
                <i class="fas fa-lightbulb mr-2"></i>Get Suggestions
            </button>
            <button id="save-email-btn" class="btn btn-primary">
                <i class="fas fa-save mr-2"></i>Save Changes
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Campaign Builder JavaScript
let recipientsData = [];
let emailsData = [];
let currentEditIndex = -1;
let campaignInterval = null;

// Email style selector - update descriptions
document.getElementById('email-style-select').addEventListener('change', (e) => {
    const style = e.target.value;
    const description = document.getElementById('style-description');
    const templateRequired = document.getElementById('template-required');
    const messageTemplate = document.getElementById('message-template');

    if (style === 'custom') {
        description.textContent = 'Custom: You write email, AI adds 2-3 lines explaining WHY they need it';
        templateRequired.classList.remove('hidden');
        messageTemplate.required = true;
    } else if (style === 'concise') {
        description.textContent = 'Concise: Short, punchy, fact-based (like YC applications)';
        templateRequired.classList.add('hidden');
        messageTemplate.required = false;
    } else {
        description.textContent = 'Standard: Professional, detailed email with full AI generation';
        templateRequired.classList.add('hidden');
        messageTemplate.required = false;
    }
});

// Additional Materials Upload
let uploadedMaterials = [];
const materialsUploadArea = document.getElementById('materials-upload-area');
const materialsInput = document.getElementById('materials-input');
const materialsList = document.getElementById('materials-list');

materialsUploadArea.addEventListener('click', () => materialsInput.click());

materialsInput.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);

    // Upload files to server
    const formData = new FormData();
    files.forEach(file => {
        // Check file size (max 10MB per file)
        if (file.size > 10 * 1024 * 1024) {
            showToast(`File ${file.name} is too large (max 10MB)`, 'error');
            return;
        }
        formData.append('files', file);
        uploadedMaterials.push(file);
    });

    try {
        // Upload to server
        const response = await fetch('/api/upload-materials', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.error) {
            showToast(data.error, 'error');
            return;
        }

        // Display files in list
        files.forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between bg-gray-50 p-2 rounded';

            const fileIcon = getFileIcon(file.name);
            const fileSize = (file.size / 1024).toFixed(1) + ' KB';

            fileItem.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="${fileIcon} text-blue-600"></i>
                    <span class="text-sm text-gray-700">${file.name}</span>
                    <span class="text-xs text-gray-500">(${fileSize})</span>
                </div>
                <button class="text-red-500 hover:text-red-700" onclick="removeMaterial('${file.name}')">
                    <i class="fas fa-times"></i>
                </button>
            `;

            materialsList.appendChild(fileItem);
        });

        if (uploadedMaterials.length > 0) {
            materialsList.classList.remove('hidden');
            showToast(`${files.length} file(s) uploaded successfully`, 'success');
        }

    } catch (error) {
        showToast('Error uploading files', 'error');
    }
});

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const icons = {
        'pdf': 'fas fa-file-pdf',
        'docx': 'fas fa-file-word',
        'doc': 'fas fa-file-word',
        'jpg': 'fas fa-file-image',
        'jpeg': 'fas fa-file-image',
        'png': 'fas fa-file-image',
        'gif': 'fas fa-file-image',
        'mp4': 'fas fa-file-video',
        'avi': 'fas fa-file-video',
        'mov': 'fas fa-file-video'
    };
    return icons[ext] || 'fas fa-file';
}

function removeMaterial(filename) {
    uploadedMaterials = uploadedMaterials.filter(f => f.name !== filename);

    // Rebuild the list
    materialsList.innerHTML = '';
    uploadedMaterials.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between bg-gray-50 p-2 rounded';
        const fileIcon = getFileIcon(file.name);
        const fileSize = (file.size / 1024).toFixed(1) + ' KB';

        fileItem.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="${fileIcon} text-blue-600"></i>
                <span class="text-sm text-gray-700">${file.name}</span>
                <span class="text-xs text-gray-500">(${fileSize})</span>
            </div>
            <button class="text-red-500 hover:text-red-700" onclick="removeMaterial('${file.name}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        materialsList.appendChild(fileItem);
    });

    if (uploadedMaterials.length === 0) {
        materialsList.classList.add('hidden');
    }

    showToast('File removed', 'info');
}

// CSV File upload
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('file-input');

console.log('Upload script loaded - Version 2.0');
console.log('Upload area:', uploadArea);
console.log('File input:', fileInput);

uploadArea.addEventListener('click', () => {
    console.log('Upload area clicked, triggering file input');
    fileInput.click();
});

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) handleFileUpload(files[0]);
});

fileInput.addEventListener('change', (e) => {
    console.log('File input changed, files:', e.target.files);
    if (e.target.files.length > 0) handleFileUpload(e.target.files[0]);
});

async function handleFileUpload(file) {
    console.log('handleFileUpload called with file:', file.name);
    const formData = new FormData();
    formData.append('file', file);

    try {
        uploadArea.innerHTML = '<div class="spinner"></div><p class="mt-2">Processing file...</p>';
        console.log('Uploading to /api/upload...');

        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });

        console.log('Upload response status:', response.status);
        const data = await response.json();
        console.log('Upload response data:', data);

        if (data.error) {
            showToast(data.error, 'error');
            resetUploadArea();
            return;
        }

        recipientsData = data.recipients;
        displayUploadStats(data.total);
        showToast(`Successfully loaded ${data.total} recipients!`, 'success');

    } catch (error) {
        showToast('Error uploading file', 'error');
        resetUploadArea();
    }
}

function resetUploadArea() {
    uploadArea.innerHTML = `
        <i class="fas fa-file-upload text-4xl text-gray-400 mb-3"></i>
        <p class="text-gray-700 font-medium">Drag & drop your file here</p>
        <p class="text-sm text-gray-500 mt-2">or click to browse</p>
        <p class="text-xs text-gray-400 mt-3">Supports CSV, Excel (max 5MB)</p>
    `;
}

function displayUploadStats(total) {
    document.getElementById('upload-stats').classList.remove('hidden');
    document.getElementById('generate-emails-btn').classList.remove('hidden');
    document.getElementById('total-count').textContent = total;
    document.getElementById('valid-count').textContent = total;

    const interval = parseInt(document.getElementById('interval-select').value);
    const minutes = total * (interval / 60);
    const hours = Math.floor(minutes / 60);
    const mins = Math.round(minutes % 60);
    document.getElementById('time-estimate').textContent =
        hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;

    uploadArea.innerHTML = `
        <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
        <p class="text-gray-700 font-medium">${total} recipients loaded</p>
        <p class="text-sm text-gray-500 mt-2">${total} valid emails found</p>
    `;
}

// Update interval display
document.getElementById('interval-select').addEventListener('change', (e) => {
    const interval = parseInt(e.target.value);
    const minutes = interval / 60;
    const displayText = minutes < 1 ? `${interval} seconds` : `${minutes} minute${minutes > 1 ? 's' : ''}`;
    document.getElementById('interval-display').textContent = displayText;

    // Update estimated time if recipients loaded
    if (recipientsData.length > 0) {
        const totalMinutes = recipientsData.length * minutes;
        const hours = Math.floor(totalMinutes / 60);
        const mins = Math.round(totalMinutes % 60);
        document.getElementById('time-estimate').textContent =
            hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
    }
});

// Generate emails with AI
document.getElementById('generate-emails-btn').addEventListener('click', async () => {
    const audience = document.getElementById('audience-select').value;
    const emailStyle = document.getElementById('email-style-select').value;
    const product = document.getElementById('product-info').value;
    const subjectTemplate = document.getElementById('subject-template').value;
    const messageTemplate = document.getElementById('message-template').value;
    const ourCompany = document.getElementById('company-info').value;

    const btn = document.getElementById('generate-emails-btn');
    btn.innerHTML = '<div class="spinner"></div><span class="ml-2">Generating emails...</span>';
    btn.disabled = true;

    emailsData = [];

    for (let i = 0; i < recipientsData.length; i++) {
        const recipient = recipientsData[i];

        try {
            const response = await fetch('/api/ai/generate-email', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    company: recipient,
                    product: product,
                    audience: audience,
                    email_style: emailStyle,
                    subject_template: subjectTemplate,
                    message_template: messageTemplate,
                    our_company: ourCompany
                })
            });

            const data = await response.json();

            emailsData.push({
                to: recipient.email,
                company: recipient.company,
                subject: data.subject || subjectTemplate.replace('{{company}}', recipient.company),
                body: data.body || product,
                status: 'pending'
            });

            // Update progress
            btn.innerHTML = `<div class="spinner"></div><span class="ml-2">Generated ${i + 1}/${recipientsData.length}...</span>`;

        } catch (error) {
            console.error('Error generating email:', error);
            // Fallback email
            emailsData.push({
                to: recipient.email,
                company: recipient.company,
                subject: subjectTemplate.replace('{{company}}', recipient.company),
                body: `Dear ${recipient.company} team,\n\n${product}\n\nBest regards`,
                status: 'pending'
            });
        }
    }

    btn.innerHTML = '<i class="fas fa-magic mr-2"></i>Generate AI Emails';
    btn.disabled = false;

    displayEmailPreviews();
    showToast(`Generated ${emailsData.length} personalized emails!`, 'success');
});

function displayEmailPreviews() {
    const emailList = document.getElementById('email-list');
    emailList.innerHTML = '';

    emailsData.forEach((email, index) => {
        const emailCard = document.createElement('div');
        emailCard.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition';
        emailCard.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900">${email.company}</h4>
                    <p class="text-sm text-gray-600">${email.to}</p>
                </div>
                <button class="btn btn-secondary btn-sm edit-email-btn" data-index="${index}">
                    <i class="fas fa-edit mr-1"></i>Edit
                </button>
            </div>
            <div class="bg-gray-50 rounded p-3 mt-2">
                <p class="text-sm font-medium text-gray-700"><strong>Subject:</strong> ${email.subject}</p>
                <p class="text-sm text-gray-600 mt-2">${email.body.substring(0, 150)}...</p>
            </div>
        `;
        emailList.appendChild(emailCard);
    });

    // Attach edit listeners
    document.querySelectorAll('.edit-email-btn').forEach(btn => {
        btn.addEventListener('click', () => openEditModal(parseInt(btn.dataset.index)));
    });

    document.getElementById('email-preview-section').classList.remove('hidden');
    document.getElementById('emails-count').textContent = emailsData.length;
}

// Edit modal
function openEditModal(index) {
    currentEditIndex = index;
    const email = emailsData[index];
    const recipient = recipientsData[index];

    document.getElementById('modal-company-name').textContent = email.company;
    document.getElementById('modal-company-name').setAttribute('data-company-name', email.company);
    document.getElementById('modal-company-email').textContent = email.to;
    document.getElementById('modal-subject').value = email.subject;
    document.getElementById('modal-body').value = email.body;

    if (recipient.details) {
        document.getElementById('modal-company-details').textContent = recipient.details;
        document.getElementById('modal-company-details').classList.remove('hidden');
        document.getElementById('modal-company-details').setAttribute('data-company-details', recipient.details);
    }

    updateCharCounts();
    document.getElementById('edit-modal').classList.remove('hidden');
    document.getElementById('edit-modal').classList.add('flex');
}

document.getElementById('close-modal').addEventListener('click', () => {
    document.getElementById('edit-modal').classList.add('hidden');
    document.getElementById('edit-modal').classList.remove('flex');
});

document.getElementById('save-email-btn').addEventListener('click', () => {
    emailsData[currentEditIndex].subject = document.getElementById('modal-subject').value;
    emailsData[currentEditIndex].body = document.getElementById('modal-body').value;
    document.getElementById('edit-modal').classList.add('hidden');
    document.getElementById('edit-modal').classList.remove('flex');
    displayEmailPreviews();
    showToast('Email updated!', 'success');
});

// Character counters
['modal-subject', 'modal-body'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateCharCounts);
});

function updateCharCounts() {
    const subject = document.getElementById('modal-subject').value;
    const body = document.getElementById('modal-body').value;

    document.getElementById('subject-length').textContent = subject.length;
    document.getElementById('body-chars').textContent = body.length;
    document.getElementById('body-words').textContent = body.trim().split(/\s+/).length;
}

// Test Email
document.getElementById('test-email-btn').addEventListener('click', async () => {
    if (emailsData.length === 0) {
        showToast('Please generate emails first', 'warning');
        return;
    }

    const testEmail = prompt('Enter your email address to receive a test email:');
    if (!testEmail || !testEmail.includes('@')) {
        showToast('Invalid email address', 'error');
        return;
    }

    try {
        const btn = document.getElementById('test-email-btn');
        btn.innerHTML = '<div class="spinner"></div><span class="ml-2">Sending...</span>';
        btn.disabled = true;

        // Send first email as test
        const testEmailData = {
            to: testEmail,
            subject: emailsData[0].subject,
            body: emailsData[0].body
        };

        const response = await fetch('/api/emails/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(testEmailData)
        });

        const data = await response.json();

        if (data.success) {
            showToast(`Test email sent to ${testEmail}!`, 'success');
        } else {
            showToast(data.error || 'Failed to send test email', 'error');
        }

        btn.innerHTML = '<i class="fas fa-flask mr-2"></i>Send Test Email';
        btn.disabled = false;

    } catch (error) {
        showToast('Error sending test email', 'error');
        document.getElementById('test-email-btn').innerHTML = '<i class="fas fa-flask mr-2"></i>Send Test Email';
        document.getElementById('test-email-btn').disabled = false;
    }
});

// Start campaign
document.getElementById('start-campaign-btn').addEventListener('click', async () => {
    if (!confirm(`Launch campaign to ${emailsData.length} recipients?`)) return;

    try:
        const interval = parseInt(document.getElementById('interval-select').value);

        // Get attachment filenames
        const attachmentFilenames = uploadedMaterials.map(f => f.name);

        const response = await fetch('/api/campaign/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                emails: emailsData,
                interval: interval,
                attachments: attachmentFilenames
            })
        });

        const data = await response.json();

        if (data.success) {
            document.getElementById('email-preview-section').classList.add('hidden');
            document.getElementById('campaign-progress-section').classList.remove('hidden');
            startProgressTracking();
            showToast('Campaign launched!', 'success');
        }

    } catch (error) {
        showToast('Error starting campaign', 'error');
    }
});

// Progress tracking
function startProgressTracking() {
    campaignInterval = setInterval(updateCampaignProgress, 2000);
}

async function updateCampaignProgress() {
    try {
        const response = await fetch('/api/campaign/status');
        const data = await response.json();

        if (data.status === 'completed' || data.status === 'cancelled') {
            clearInterval(campaignInterval);
            showToast('Campaign completed!', 'success');
        }

        updateProgressUI(data);

    } catch (error) {
        console.error('Error fetching progress:', error);
    }
}

function updateProgressUI(data) {
    const percent = Math.round((data.sent + data.failed) / data.total * 100);

    document.getElementById('progress-text').textContent = `${data.sent + data.failed} / ${data.total}`;
    document.getElementById('progress-percent').textContent = percent;
    document.getElementById('progress-bar').style.width = `${percent}%`;
    document.getElementById('sent-count').textContent = data.sent;
    document.getElementById('failed-count').textContent = data.failed;
    document.getElementById('pending-count').textContent = data.total - data.sent - data.failed;

    // Update details
    const detailsDiv = document.getElementById('progress-details');
    if (data.progress && data.progress.length > 0) {
        const latest = data.progress[data.progress.length - 1];
        const item = document.createElement('div');
        item.className = `flex justify-between items-center p-2 rounded ${latest.status === 'sent' ? 'bg-green-50' : 'bg-red-50'}`;
        item.innerHTML = `
            <span class="text-sm">${latest.company}</span>
            <span class="badge badge-${latest.status === 'sent' ? 'success' : 'danger'}">${latest.status}</span>
        `;
        detailsDiv.insertBefore(item, detailsDiv.firstChild);
    }
}

// Campaign controls
document.getElementById('pause-btn').addEventListener('click', async () => {
    await fetch('/api/campaign/pause', { method: 'POST' });
    document.getElementById('pause-btn').classList.add('hidden');
    document.getElementById('resume-btn').classList.remove('hidden');
    showToast('Campaign paused', 'warning');
});

document.getElementById('resume-btn').addEventListener('click', async () => {
    await fetch('/api/campaign/resume', { method: 'POST' });
    document.getElementById('resume-btn').classList.add('hidden');
    document.getElementById('pause-btn').classList.remove('hidden');
    showToast('Campaign resumed', 'success');
});

document.getElementById('cancel-btn').addEventListener('click', async () => {
    if (confirm('Cancel campaign?')) {
        await fetch('/api/campaign/cancel', { method: 'POST' });
        clearInterval(campaignInterval);
        showToast('Campaign cancelled', 'error');
    }
});
</script>
{% endblock %}
